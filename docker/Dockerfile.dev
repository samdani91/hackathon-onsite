FROM node:24-alpine AS builder

WORKDIR /app

# Copy only package files first for better caching
COPY package*.json ./

# Install all dependencies (including devDependencies for development)
RUN npm install

# Development runtime stage
FROM node:24-alpine

# Install tini for proper signal handling
RUN apk add --no-cache tini

WORKDIR /app

# Copy dependencies from builder stage
COPY --from=builder /app/node_modules ./node_modules
COPY package*.json ./

# Source will be mounted as volume in development
# COPY src ./src

# Use non-root user
USER node

EXPOSE 3000

# Use tini as entrypoint for proper signal handling
ENTRYPOINT ["/sbin/tini", "--"]

# Run in dev mode with watch
CMD ["npm", "run", "dev"]
