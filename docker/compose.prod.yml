name: delineate

services:
  delineate-app:
    # Use the pre-built image
    image: delineate-hackathon-challenge:latest
    pull_policy: never
    # build:
    #   context: ..
    #   dockerfile: docker/Dockerfile.prod
    #   # Enable BuildKit caching
    #   args:
    #     BUILDKIT_INLINE_CACHE: 1
    ports:
      - "3000:3000"
    env_file:
      - ../.env
      - ../.env.storage
    environment:
      - NODE_ENV=production
      - DOWNLOAD_DELAY_MIN_MS=5000
      - DOWNLOAD_DELAY_MAX_MS=10000
      # S3 configuration - endpoint override for container networking
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      - S3_ENDPOINT=http://delineate-storage:9000
    depends_on:
      delineate-storage-init:
        condition: service_completed_successfully
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp

  delineate-nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - delineate-app
    security_opt:
      - no-new-privileges:true

  delineate-storage:
    image: rustfs/rustfs:latest
    ports:
      - "9000:9000"
      - "9001:9001"
    env_file:
      - ../.env.storage
    environment:
      - RUSTFS_ACCESS_KEY=minioadmin
      - RUSTFS_SECRET_KEY=minioadmin
      - S3_BACKEND=fs
      - S3_FS_ROOT=/data
    volumes:
      - rustfs-data:/data
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "9000"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 15s

  delineate-storage-init:
    image: amazon/aws-cli:latest
    depends_on:
      delineate-storage:
        condition: service_healthy
    env_file:
      - ../.env.storage
    environment:
      - AWS_DEFAULT_REGION=us-east-1
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        aws --endpoint-url http://delineate-storage:9000 s3 mb s3://downloads --region us-east-1 || true
        echo "Bucket 'downloads' is ready"

  delineate-frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
      args:
        BUILDKIT_INLINE_CACHE: 1
    ports:
      - "80:80"
    env_file:
      - ../.env
      - ../frontend/.env
    depends_on:
      - delineate-app
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true

volumes:
  rustfs-data:
    driver: local
